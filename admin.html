<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADM — Ajude um amigo</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b3d14;
      color: #fff;
      padding: 18px;
    }
    .wrap { max-width: 920px; margin: 0 auto; }
    h1 { margin: 0 0 6px 0; }
    p { margin: 0 0 14px 0; opacity: .92; }
    .card {
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.22);
      border-radius: 16px;
      padding: 14px;
      backdrop-filter: blur(8px);
    }
    .row { display: grid; grid-template-columns: 1fr 180px 120px; gap: 10px; margin: 10px 0; }
    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.25);
      color: #fff;
      outline: none;
    }
    button {
      border: 0;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      cursor: pointer;
      background: rgba(255,255,255,.92);
      color: #06210c;
    }
    button[disabled]{ opacity:.65; cursor:not-allowed; }
    button.ghost {
      background: rgba(0,0,0,.25);
      color: #fff;
      border: 1px solid rgba(255,255,255,.22);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow: hidden;
      border-radius: 12px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      text-align: left;
    }
    th { opacity: .9; }
    .actions { display:flex; gap:8px; }
    .muted { opacity: .85; font-size: 13px; }
    .topbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    .topbar a { color:#fff; text-decoration:none; opacity:.9; }
    @media (max-width: 720px){
      .row{ grid-template-columns: 1fr; }
      .actions{ width:100%; justify-content:space-between; }
      button{ width:100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>ADM — Rank</h1>
        <div class="muted">Somente você edita. O público só vê.</div>
      </div>
      <div class="actions">
        <!-- ✅ Voltar funciona em qualquer domínio -->
        <a href="./" class="muted">← voltar ao site</a>
      </div>
    </div>

    <div class="card" id="authCard">
      <p>Digite sua senha de admin para editar o rank.</p>
      <div class="row" style="grid-template-columns: 1fr 180px;">
        <input id="token" type="password" placeholder="Senha admin" autocomplete="current-password" />
        <button id="loginBtn">Entrar</button>
      </div>
      <div class="muted" id="authMsg"></div>
    </div>

    <div class="card" id="appCard" style="display:none; margin-top:14px;">
      <div class="row">
        <input id="name" placeholder="Nome" autocomplete="off" />
        <input id="value" placeholder="Valor (ex: 25.50)" inputmode="decimal" autocomplete="off" />
        <button id="addBtn">Adicionar</button>
      </div>

      <div class="actions" style="justify-content: space-between; margin-top:10px;">
        <button class="ghost" id="reloadBtn" type="button">Recarregar</button>
        <button class="ghost" id="clearBtn" type="button">Zerar lista</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Valor (R$)</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="muted" id="msg" style="margin-top:10px;"></div>
    </div>
  </div>

  <script>
    const authCard = document.getElementById("authCard");
    const appCard  = document.getElementById("appCard");
    const tokenEl  = document.getElementById("token");
    const authMsg  = document.getElementById("authMsg");
    const msgEl    = document.getElementById("msg");

    const nameEl   = document.getElementById("name");
    const valueEl  = document.getElementById("value");
    const addBtn   = document.getElementById("addBtn");
    const reloadBtn= document.getElementById("reloadBtn");
    const clearBtn = document.getElementById("clearBtn");
    const tbody    = document.getElementById("tbody");
    const loginBtn = document.getElementById("loginBtn");

    let TOKEN = "";

    function setBusy(on){
      loginBtn.disabled = on;
      addBtn.disabled = on;
      reloadBtn.disabled = on;
      clearBtn.disabled = on;
    }

    function parseValue(v) {
      const s = String(v).trim().replace(",", ".");
      const n = Number(s);
      if (Number.isNaN(n) || n < 0) return null;
      return Math.round(n * 100) / 100;
    }

    async function apiGet() {
      const res = await fetch("/.netlify/functions/rank", { cache:"no-store" });
      if(!res.ok) throw new Error("Erro ao carregar rank (GET).");
      return res.json();
    }

    async function apiSave(data) {
      const res = await fetch("/.netlify/functions/rank", {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "authorization": "Bearer " + TOKEN
        },
        body: JSON.stringify(data)
      });

      if(!res.ok) {
        const t = await res.text();
        // tenta deixar mais claro
        if(res.status === 401 || res.status === 403) throw new Error("Senha inválida.");
        throw new Error(t || ("Erro ao salvar (HTTP " + res.status + ")."));
      }
      return res.json();
    }

    function formatValue(v){
      const n = Number(v)||0;
      return String(n.toFixed(2)).replace(".", ",");
    }

    function render(items) {
      tbody.innerHTML = "";
      const sorted = [...items].sort((a,b) => (Number(b.value)||0) - (Number(a.value)||0));

      for (const it of sorted) {
        const tr = document.createElement("tr");

        const td1 = document.createElement("td");
        td1.textContent = it.name ?? "—";

        const td2 = document.createElement("td");
        td2.textContent = formatValue(it.value);

        const td3 = document.createElement("td");
        const del = document.createElement("button");
        del.className = "ghost";
        del.textContent = "Excluir";

        del.onclick = async () => {
          try {
            setBusy(true);
            msgEl.textContent = "";
            const data = await apiGet();
            const next = (data.items || []).filter(x =>
              !(x.name === it.name && Number(x.value) === Number(it.value))
            );
            data.items = next;
            await apiSave(data);
            msgEl.textContent = "✅ Excluído.";
            await loadAndRender();
          } catch(e) {
            msgEl.textContent = "⚠️ " + e.message;
          } finally {
            setBusy(false);
          }
        };

        td3.appendChild(del);
        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tbody.appendChild(tr);
      }

      if(sorted.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = "<td colspan='3' class='muted'>Sem itens. Adicione acima.</td>";
        tbody.appendChild(tr);
      }
    }

    async function loadAndRender() {
      const data = await apiGet();
      render(data.items || []);
    }

    async function doLogin(){
      TOKEN = tokenEl.value.trim();
      if(!TOKEN) {
        authMsg.textContent = "Digite a senha.";
        return;
      }
      try {
        setBusy(true);
        authMsg.textContent = "Verificando...";
        // testa salvando sem mudar nada (valida token)
        const data = await apiGet();
        await apiSave(data);

        authCard.style.display = "none";
        appCard.style.display = "block";
        authMsg.textContent = "";
        msgEl.textContent = "✅ Logado.";
        await loadAndRender();
      } catch (e) {
        authMsg.textContent = "⚠️ " + (e.message || "Senha inválida ou função não ativa.");
      } finally {
        setBusy(false);
      }
    }

    loginBtn.addEventListener("click", doLogin);

    // Enter na senha
    tokenEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter") doLogin();
    });

    // Enter no valor adiciona
    valueEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter") addBtn.click();
    });

    addBtn.addEventListener("click", async () => {
      const name = nameEl.value.trim();
      const val = parseValue(valueEl.value);

      if(!name) { msgEl.textContent = "Digite um nome."; return; }
      if(val === null) { msgEl.textContent = "Digite um valor válido."; return; }

      try {
        setBusy(true);
        msgEl.textContent = "";
        const data = await apiGet();
        data.items = Array.isArray(data.items) ? data.items : [];
        data.items.push({ name, value: val });
        await apiSave(data);

        nameEl.value = "";
        valueEl.value = "";
        msgEl.textContent = "✅ Adicionado.";
        await loadAndRender();
      } catch(e) {
        msgEl.textContent = "⚠️ " + e.message;
      } finally {
        setBusy(false);
      }
    });

    reloadBtn.addEventListener("click", async () => {
      try {
        setBusy(true);
        await loadAndRender();
        msgEl.textContent = "✅ Recarregado.";
      } catch(e) {
        msgEl.textContent = "⚠️ " + e.message;
      } finally {
        setBusy(false);
      }
    });

    clearBtn.addEventListener("click", async () => {
      if(!confirm("Zerar o rank?")) return;
      try {
        setBusy(true);
        const data = await apiGet();
        data.items = [];
        await apiSave(data);
        msgEl.textContent = "✅ Zerado.";
        await loadAndRender();
      } catch(e) {
        msgEl.textContent = "⚠️ " + e.message;
      } finally {
        setBusy(false);
      }
    });
  </script>
</body>
</html>




